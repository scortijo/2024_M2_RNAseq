---
title: "Clustering des gènes"
author: "Sandra"
date: "2024-08-05"
output: rmdformats::downcute
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>
<br>

Dans cette séance, vous allez explorer les gènes différentiellement exprimés pour détecter des groupes de gènes d'intérêt.   
Dans un premier temps, vous allez regrouper tous les gènes différentiellement exprimés dans chacune des comparaisons. Puis vous allez effectuer un clustering hierarchisé pour identifier les gènes avec des réponses transcriptionnelle interessantes en réponse à la mutation *arp6-1* et/ou à la concentration en azote dans le milieu de culture.


# Préparation de l'environnement

> Dans un premier temps, créez un nouveau R markdown (ou réutilisez celui de la séance précédente) et chargez les librairies dont vous aurez besoin.  

Voici la liste des libraries dont vous aurez besoin:  
- tidyverse  
- scTenifoldNet  
- matrixStats  
- RColorBrewer  
- gplots  


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(scTenifoldNet)
library(matrixStats)
library(RColorBrewer)
library(gplots)
```

> Importez tous les fichiers contenant les résultats de DESeq pour chaque comparaison et mettez les dans des objets (un objet par comparaison)   
> Importez aussi le fichier contenant les données d'expression (Raw_featureCounts_WT_arp6.txt)

```{r, echo=FALSE, message=FALSE, warning=FALSE}


DESeq_result_arp6 <- read_tsv("../../../data/tables_DEG/DEseq_arp6_0.5mM_vs_10mM.txt")
DESeq_result_WT <- read_tsv("../../../data/tables_DEG/DEseq_WT_0.5mM_vs_10mM.txt")
DESeq_result_0.5mM <- read_tsv("../../../data/tables_DEG/DEseq_0.5mM_WT_vs_arp6.txt")
DESeq_result_10mM <- read_tsv("../../../data/tables_DEG/DEseq_10mM_WT_vs_arp6.txt")

RNAseq_data <- read_tsv("../../../data/Raw_featureCounts_WT_arp6.txt")


```


# Regroupement de tous les gènes différentiellement exprimés.

Afin de pouvoir trouver des groupes de gènes avec des expressions d'intérêt dans les différents échantillons, il nous faut tout d'abord regrouper tous les gènes différentiellement exprimés et avoir leur expression dans les différents échantillons.


- Concentrons nous d'abord sur les résultats de DESeq pour chaque comparaison. Nous ne gardons que les colonnes d'intérêt (nom des gènes et p-value ajustée), et renommons la colonne la p-value ajustée (padj) afin d'y ajouter l'information de la comparaison d'où elle vient:
```{r}
DESeq_result_arp6 <- select(DESeq_result_arp6, gene, padj ) %>% 
  rename(padj_arp6_0.5mM_vs_10mM=padj)

DESeq_result_WT <- select(DESeq_result_WT, gene, padj ) %>% 
  rename(padj_WT_0.5mM_vs_10mM=padj)

DESeq_result_0.5mM <- select(DESeq_result_0.5mM, gene, padj ) %>% 
  rename(padj_0.5mM_WT_vs_arp6=padj)

DESeq_result_10mM <- select(DESeq_result_10mM, gene, padj ) %>% 
  rename(padj_10mM_WT_vs_arp6=padj)

```


- Nous pouvons maintenant combiner les object des quatres comparaisons et le garder que les gènes pour lesquels la p-value ajustée est inférieure à 5% (padj<0.05) pour au moins une des comparaisons:
```{r}

All_DEG <- full_join(DESeq_result_arp6, DESeq_result_WT, by="gene") %>% 
  full_join(DESeq_result_0.5mM, by="gene") %>% 
  full_join(DESeq_result_10mM, by="gene") %>% 
  filter(padj_arp6_0.5mM_vs_10mM<0.05 | padj_WT_0.5mM_vs_10mM<0.05 | padj_0.5mM_WT_vs_arp6<0.05 |padj_10mM_WT_vs_arp6<0.05)
```

<br>

> Avant d'y ajouter les données d'expression, effectuez la normalisation par la taille de la librarie pour `RNAseq_data` comme dans la `séance 1` (en utilisant la fonction `cpmNormalization` du package `scTenifoldNet`).    
> A la fin, vous voulez un tableau comme celui ci-dessous, avec une colonne contenant le nom des gènes et une colonne par échantillon avec les données d'expression normalisées par la taille de la librarie. 

```{r, echo=FALSE}
RNAseq_data <- column_to_rownames(RNAseq_data, var="Geneid")
CPMnorm_RNAseq_data <- cpmNormalization(RNAseq_data)
CPMnorm_RNAseq_data <- as.data.frame.matrix(CPMnorm_RNAseq_data) %>% 
  rownames_to_column(var="gene")

tibble(CPMnorm_RNAseq_data)
```

<br>

- Nous pouvons finalement combiner les données d'expression avec les gènes différentiellement exprimés dans au moins une comparaison:
```{r}
All_DEG_CPMnorm_RNAseq_data <- inner_join(All_DEG, CPMnorm_RNAseq_data, by="gene") %>% 
  select(-padj_arp6_0.5mM_vs_10mM, -padj_WT_0.5mM_vs_10mM, -padj_0.5mM_WT_vs_arp6, -padj_10mM_WT_vs_arp6)
```

<br>

Maintenant que nous avons les données d'expression pour tous les gènes différentiellement exprimés dans au moins une comparaison, nous pouvons passer à leur analyse.


# Clustering herarchisé et heatmap

Z-score normalisation des données d'expression

```{r}

Zscore_All_DEG_CPMnorm_RNAseq_data <- mutate_at(All_DEG_CPMnorm_RNAseq_data, vars(-gene), 
                                        funs("Zscore" = (.-rowMeans(All_DEG_CPMnorm_RNAseq_data[,2:13], na.rm=TRUE))/matrixStats::rowSds(as.matrix(All_DEG_CPMnorm_RNAseq_data[,2:13])))) %>% 
  select(gene, contains("Zscore")) %>% 
  rename_with(~ gsub("_Zscore", "", .x, fixed = TRUE)) %>% 
  rename_with(~ gsub("rep", "", .x, fixed = TRUE))
```

La même chose mais sur la moyenne des 3 réplicats

```{r}



Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps <- mutate(Zscore_All_DEG_CPMnorm_RNAseq_data,
                                                       Zscore_WT_0.5mM=rowMeans(Zscore_All_DEG_CPMnorm_RNAseq_data[,11:13]),
                                                       Zscore_WT_10mM=rowMeans(Zscore_All_DEG_CPMnorm_RNAseq_data[,5:7]),
                                                       Zscore_arp6_0.5mM=rowMeans(Zscore_All_DEG_CPMnorm_RNAseq_data[,2:4]),
                                                       Zscore_arp6_10mM=rowMeans(Zscore_All_DEG_CPMnorm_RNAseq_data[,8:10])) %>% 
  select(gene, contains("Zscore")) %>% 
  rename_with(~ gsub("Zscore_", "", .x, fixed = TRUE))
  


```


Clustering hierarchisé et heatmap

```{r}

Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson <- cor(t(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps[,2:5]), method = "pearson")
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson[is.na(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson)]<-0
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist<-as.dist((1-Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson))
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist[is.na(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist)]<-0
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete <- hclust(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist, 
                                                       method="complete")
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete.den <- as.dendrogram(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete)
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete.col=brewer.pal(12, 'Set3')[cutree(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete, k = 6)]
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps$cluster_6_pearson <- cutree(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete, 
                                             k = 6)
Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps$cluster_6_pearson_color <- brewer.pal(12, 'Set3')[cutree(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete, k = 6)]


heatmap.2(as.matrix(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps[,2:5]),  
        Rowv=Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete.den,  Colv=F,
          col = bluered(100), breaks=seq(-2,2,length.out=101), trace = 'none' ,
          labRow=Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps$gene,
          labCol=names(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps[,2:5]), 
          main="All DEG (Z-score)",
          RowSideColors = Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.pearson.dist.clust.complete.col,
          na.rm=F, na.color="black", margins = c(8, 8), cexCol=1.1)


write_tsv(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps, file="clusters_Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps.txt")
```


```{r}

pivot_longer(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps,  WT_0.5mM:arp6_10mM, 
             names_to = "sample", values_to= "Zscore_mean3reps") %>% 
  mutate(sample=factor(sample, levels=c("WT_0.5mM","WT_10mM", "arp6_0.5mM", "arp6_10mM")),
         cluster_6_pearson=as.character(cluster_6_pearson)) %>% 
  ggplot(aes(x=cluster_6_pearson, y=Zscore_mean3reps, fill=sample)) +
    geom_boxplot()


pivot_longer(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps,  WT_0.5mM:arp6_10mM, 
             names_to = "sample", values_to= "Zscore_mean3reps") %>% 
  separate(sample, into=c("genotype", "KNO3"), sep="_") %>% 
  mutate(genotype=factor(genotype, levels=c("WT", "arp6")),
         KNO3=factor(KNO3, levels=c("0.5mM", "10mM")),
         cluster_6_pearson=as.character(cluster_6_pearson)) %>% 
  ggplot(aes(x=genotype, y=Zscore_mean3reps, fill=KNO3)) +
    geom_boxplot() +
  facet_wrap(~cluster_6_pearson) 

pivot_longer(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps,  WT_0.5mM:arp6_10mM, 
             names_to = "sample", values_to= "Zscore_mean3reps") %>% 
  separate(sample, into=c("genotype", "KNO3"), sep="_") %>% 
  mutate(genotype=factor(genotype, levels=c("WT", "arp6")),
         KNO3=factor(KNO3, levels=c("0.5mM", "10mM")),
         cluster_6_pearson=as.character(cluster_6_pearson)) %>% 
  ggplot(aes(x=genotype, y=Zscore_mean3reps, fill=KNO3)) +
    geom_violin() +
  facet_wrap(~cluster_6_pearson) 



group_by(Zscore_All_DEG_CPMnorm_RNAseq_data_Mean3reps, cluster_6_pearson) %>% 
  summarise(n(  ))
```





